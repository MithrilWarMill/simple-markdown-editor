<html>
    <head>
        <link rel="stylesheet" href="./css/bootstrap.min.css">
        <link rel="stylesheet" href="./css/highlight.min.css">
        <link rel="stylesheet" href="./css/common.css"
    </head>
    <body>
        <div>
            <div id="linum" class="linum"></div>
            <textarea id='editor' class="editor" rows="100"></textarea>
            <div id='preview' class="preview"></div>
        </div>
    </body>
    <script src="./js/jquery.min.js"></script>
    <script src="./js/bootstrap.min.js"></script>
    <script src="./js/marked.min.js"></script>
    <script src="./js/highlight.min.js"></script>
    <script type="text/javascript">
    old_linum = 1;
    // add line number with textarea growing
    function set_linum() {
        new_linum = $('#editor').height() / 15;// how many lines
        $('#linum').height($('#editor').height());
        for(i = old_linum;i < new_linum; i++){
            $('#linum').append(i+'</br>');
        }
        old_linum = new_linum;
    }

    $(document).ready(function(){
        set_linum();
        is_grow = false;
        $(document).on('keyup', 'textarea', function(e) {
            //  the following will help the text expand as typing takes place
            while($(this).outerHeight() < this.scrollHeight + parseFloat($(this).css("borderTopWidth")) + parseFloat($(this).css("borderBottomWidth"))) {
                $(this).height($(this).height()+1);
                console.log($(this).height());
                console.log($('#editor').height());
                is_grow = true;
            };
            if (is_grow) {
                set_linum();
                is_grow = false;
            }
        });

        function re_render () {
            var md_content = $('#editor').val();
            html_content = marked(md_content);
            $('#preview').html(html_content);
            $('pre code').each(function(i, block) {
                hljs.highlightBlock(block);
            });
        };
        
        //setup before functions
        var typingTimer;                //timer identifier
        var doneTypingInterval = 1000;  //time in ms
        var $input = $('#editor');

        //on keyup, start the countdown
        $input.on('keyup', function () {
            clearTimeout(typingTimer);
            typingTimer = setTimeout(re_render, doneTypingInterval);
        });

        //on keydown, clear the countdown 
        $input.on('keydown', function () {
            clearTimeout(typingTimer);
        });
        
        // hook keys
        $('#editor').on('keydown', function(e) {
            var keyCode = e.keyCode || e.which;
            // hook TAB key
            if (keyCode == 9) {
                e.preventDefault();
                var start = $(this).get(0).selectionStart;
                var end = $(this).get(0).selectionEnd;

                // insert 4 spaces instead
                $(this).val($(this).val().substring(0, start)
                        + '    '
                    + $(this).val().substring(end));

                // put caret at right position again
                $(this).get(0).selectionStart =
                $(this).get(0).selectionEnd = start + 4;
            }
        });
    });
    </script>
</html>
